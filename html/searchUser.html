<!DOCTYPE html>
<html>
	<head>
		<script src="https://www.gstatic.com/firebasejs/7.5.2/firebase.js"></script>
		<script>
			var firebaseConfig = {
			apiKey: "AIzaSyAEDMbvbs6q_Z22HVr0-ypGGQW7GA8srUk",
			authDomain: "ktp-schedule-planner.firebaseapp.com",
			databaseURL: "https://ktp-schedule-planner.firebaseio.com",
			projectId: "ktp-schedule-planner",
			storageBucket: "ktp-schedule-planner.appspot.com",
			messagingSenderId: "195731099861",
			appId: "1:195731099861:web:a42454058015aef2b2925c"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			
			var db = firebase.firestore();

			var user = "temporaryUser" //TODO: get logged in user
			
			
			function search(username){
				//var crn = document.getElementById("crn").value;
				//var username = document.getElementById("username").value;
				/*var quarter = document.getElementById("quarter").value;
				var year = document.getElementById("year").value;*/
				console.log(username);
				
				db.collection("students").doc(username).get().then((documentSnapshot) => {
					//console.dir(documentSnapshot);
					var studentDataDocumentSnapshot = documentSnapshot.data();
					//console.dir(studentDataDocumentSnapshot);
					document.getElementById("demoOutput").innerHTML = "Found";

					/*console.log("For each course...");
					documentSnapshot.get("Courses").forEach(element => console.log(element));*/
					
					
					//console.log(studentDataDocumentSnapshot["Courses"][0]);
					
					
					/*studentDataDocumentSnapshot["Courses"][0].get().then(snapshot => {
						console.log("Specific data:");
						console.log(snapshot.data());
					});*/
					
					var tempStudentCourses =  {Courses : {}};
					
					studentDataDocumentSnapshot["Courses"].forEach(thisCourseSnapshot => {
						thisCourseSnapshot.get().then(courseSnapshot => {
							//console.log("Student has course:");
							//console.log(courseSnapshot.data());
							tempStudentCourses["Courses"][courseSnapshot.data()["Course"]] = courseSnapshot.data();
							//console.dir(tempStudentCourses);
						});
					});
					
					console.log("All courses loaded (beware of async):");
					console.dir(tempStudentCourses);
				});

			}

			function load() {
				console.log("Search page loaded");
				/*var select = document.getElementById('year');
				var year = new Date().getFullYear();

				for (var i = 0; i < 5 ; i++) {
					var opt = document.createElement('option');
					var startYearShort = `${year-i}`.substring(2);
					var endYearShort = `${year-i+1}`.substring(2);
					var yearsShort = `${startYearShort}${endYearShort}`
					console.log(yearsShort);
					opt.value = yearsShort;
					opt.innerHTML = `${year-i}-${year-i+1}`;
					select.appendChild(opt);
				}*/
			}
			
			function demoFirestoreButton() {
				console.log("Logging all students' info...");
				
				db.collection("students").get().then((querySnapshot) => {
					querySnapshot.forEach((doc) => {
						console.log(`${doc.id} =>`);
						console.dir(doc.data());
					});
					//console.log(querySnapshot.docs[0].data());
					/*querySnapshot.get("Courses").then((doc) => {
						console.log(`${doc.id} =>`);
						console.dir(doc.data());
					});*/
				});
			}
			
		</script>
	</head>
	<body onload="load()">
		<br> Year:
			<select id="year">
			</select>
		<br>
		<br> Quarter:
			<select id="quarter">
				<option value="FALL">Fall</option>
				<option value="WINTER">Winter</option>
				<option value="SPRING">Spring</option>
				<option value="SUMMER">Summer</option>
			</select>
		<br>
		<!--<br>CRN: <input type="text" id="crn"><br>-->
		<br>Username: <input type="text" id="username" value="chatfitt"/><br>
		<br><button onclick="search(document.getElementById(&quot;username&quot;).value)">Search</button><br>
		<br><p id="demoOutput">This text will change if student found</p><br>
		<br/><button onclick="demoFirestoreButton()">Demo Firestore Button</button><br/>
		<br/>
		<iframe style="width:100%; height:300px;" src="userSchedule.html"></iframe>
	</body>
</html>